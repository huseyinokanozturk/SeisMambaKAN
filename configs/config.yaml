# =====================================================================
# Global configuration for SeisMambaKAN
# =====================================================================

# -----------------------------
# DATASET CONFIGURATION
# -----------------------------
data:
  # Dataset mode: "all" uses the full cleaned dataset,
  # "sample" uses a smaller subset mainly for debugging and smoke tests.
  mode: "sample"              # "all" or "sample"

  # Total number of samples to draw when mode == "sample".
  sample_size: 1300

  # Fraction of earthquake samples within the sample subset.
  # For example, eq_ratio=0.75 → 75% earthquakes, 25% noise.
  eq_ratio: 0.75

  # Whether to include noise traces in the dataset at all.
  use_noise: true

  # Raw signal properties (STEAD default)
  sampling_rate_hz: 100    # STEAD is 100 Hz
  window_seconds: 60       # 60 s window → 6000 samples
  n_channels: 3            # typically (E, N, Z) or similar

# -----------------------------
# DATA SPLIT CONFIGURATION
# -----------------------------
split:
  # Fractions for train/validation/test splits.
  train: 0.8
  val: 0.1
  test: 0.1

# -----------------------------
# CLEANING / QUALITY FILTERS
# -----------------------------
cleaning:
  # Acceptable P–S time difference in seconds.
  min_ps_seconds: 0.5
  max_ps_seconds: 35.0

  # Whether to allow missing S picks (future extension).
  allow_missing_s: false

  # Whether to drop records with missing P picks.
  drop_if_missing_p: true

  # Valid range for P/S arrival sample indices within the window.
  window_samples:
    min: 0
    max: 6000

# -----------------------------
# PREPROCESSING (ON WAVEFORM)
# -----------------------------
preprocessing:
  # Only amplitude normalization is applied.
  # STEAD already performed detrend + bandpass filtering.
  # Options: "zscore", "maxabs", "none"
  normalization: "zscore"

# =====================================================================
# LABEL GENERATION CONFIGURATION
# =====================================================================
labels:
  # Total time steps used for label generation (should match window length).
  total_length: 6000

  # Detection head target:
  # Typically a wider window around P and/or between P and S.
  detection:
    # Label type for detection head (currently "gaussian" or "binary" planned).
    type: "gaussian"

    # Standard deviation of the Gaussian (in samples) used for detection target.
    sigma_samples: 10.0

    # Peak value of the Gaussian target.
    peak_value: 1.0

    # Optional margin for expanding the detection region around P/S.
    # This can be used for binary-style targets (e.g., 1 within ±margin).
    margin_samples: 5

  # Phase picking heads for P and S phases.
  phase:
    # P-phase Gaussian label parameters.
    p_sigma_samples: 10.0
    # S-phase Gaussian label parameters.
    s_sigma_samples: 10.0

    # Peak value for both P and S Gaussian labels.
    peak_value: 1.0

  # How to represent noise traces (without P/S picks).
  noise_policy:
    # Index values used when P or S is not available (e.g., noise traces).
    # -1 means "no valid pick".
    p_index: -1
    s_index: -1

# =====================================================================
# DATA AUGMENTATION CONFIGURATION
# =====================================================================
augmentation:
  # Global switch to enable/disable all augmentations.
  enable: true

  # -------------------------
  # Random time shift
  # -------------------------
  random_shift:
    # Probability of applying a random temporal shift to the trace.
    prob: 0.75
    # Maximum absolute shift in samples (both positive and negative).
    max_shift_samples: 30

  # -------------------------
  # Additive noise
  # -------------------------
  additive_noise:
    # Probability of adding Gaussian noise to the waveform.
    prob: 0.5
    # Standard deviation of the noise relative to the normalized signal.
    std: 0.05

  # -------------------------
  # Amplitude scaling
  # -------------------------
  amplitude_scale:
    # Probability of applying random global scaling to the waveform.
    prob: 0.3
    # Range for the random scaling factor.
    min: 0.9
    max: 1.1

  # -------------------------
  # Channel dropout
  # -------------------------
  channel_dropout:
    # Probability of dropping one or more channels (set to zero).
    prob: 0.1
    # Possible numbers of channels to drop, randomly chosen from this list.
    # Example: [1] → always drop exactly one channel when triggered.
    num_channels_choices: [1]

  # -------------------------
  # Secondary event injection
  # -------------------------
  secondary_event:
    # Whether to enable secondary event injection.
    enable: false
    # Probability of injecting a secondary earthquake waveform into the trace.
    probability: 0.4
    # Scaling factor for the secondary event amplitude.
    scale_min: 0.05  
    scale_max: 0.2
    min_offset_samples: 400

# =====================================================================
# TRAINING & DATALOADER CONFIGURATION
# =====================================================================
training:
  # Global random seed used for reproducibility.
  seed: 42

  # Base batch size for training.
  batch_size: 128

  # Total number of training epochs (used later in the trainer).
  epochs: 50

  # Initial learning rate (optimizer configuration will use this).
  learning_rate: 3.0e-4

dataloader:
  # Number of worker processes for PyTorch DataLoader.
  num_workers: 1

  # Whether to pin memory to speed up host-to-device transfers.
  pin_memory: true

  # Whether to keep workers alive between epochs.
  persistent_workers: true

  # Number of batches prefetched by each worker.
  prefetch_factor: 2

  # Whether to drop the last (possibly incomplete) batch during training.
  drop_last: true

  # Whether to shuffle the training dataset each epoch.
  shuffle_train: true

# =====================================================================
# LOSS FUNCTION CONFIGURATION
# =====================================================================

loss:
  # High-level type for logging / debugging
  type: "multi_head_seismambakan"

  # Which keys in the label dict correspond to each head
  keys:
    detection: "y_det"
    p: "y_p"
    s: "y_s"

  # Global weights for each head in the final loss:
  #   L_total = w_det * L_det + w_p * L_p + w_s * L_s
  weights:
    detection: 0.1    # lambda_det
    p: 0.3            # lambda_P
    s: 0.4            # lambda_S (slightly higher, as S is harder)

  # --------------------------------------------------------------------------
  # Detection head loss: weighted BCE (optionally focal)
  # --------------------------------------------------------------------------
  detection:
    loss_type: "bce"        # ["bce", "focal_bce"] – plain BCE
    positive_weight: 5.0    # weight for y=1 samples to handle imbalance
    use_focal: false        # if true, use focal variant instead of plain BCE
    focal_alpha: 0.25       # only used when use_focal = true
    focal_gamma: 2.0        # focusing parameter for focal loss
    eps: 1.0e-7             # numerical stability for log / clamp

  # --------------------------------------------------------------------------
  # Phase heads loss: detection-masked, peak-weighted MSE on Gaussian targets
  # --------------------------------------------------------------------------
  phase:
    loss_type: "masked_peak_mse"  
    # Peak weighting: w_t = 1 + peak_weight_scale * y_phase(t)
    peak_weight_scale: 2.0        # k in w_t = 1 + k * y(t); tuneable
    use_detection_mask: true      # multiply by detection label to focus on event window
    normalize_by_mask: true       # divide by sum(mask * weights) instead of T
    # Clamp predictions to [0, 1] before computing MSE (since labels are in [0, 1])
    clamp_predictions: true
    clamp_min: 0.0
    clamp_max: 1.0
    eps: 1.0e-6                   # for safe normalization

  # --------------------------------------------------------------------------
  # Optional center-based loss (soft-argmax on P/S), disabled for now
  # --------------------------------------------------------------------------
  center_loss:
    enabled: false         # keep off in first experiments
    weight: 0.0            # lambda_center; non-zero only if enabled = true
    temperature: 10.0      # controls sharpness of soft-argmax over time axis

metrics:
  # ============================================================================
  # General Settings
  # ============================================================================
  sample_rate: 100.0              # Sampling frequency in Hz (STEAD default).
  window_length: 6000             # Number of samples per waveform segment.

  # ============================================================================
  # Detection Evaluation Settings
  # ============================================================================
  detection:
    # Threshold for deciding whether a trace contains an earthquake event.
    # If max(det_prob) >= trace_threshold → event is detected.
    trace_threshold: 0.5

    # Threshold used for per-sample (time-step) binary classification
    # when computing frame-level precision/recall/F1.
    timestep_threshold: 0.5

  # ============================================================================
  # Phase Picker Settings (P/S Estimation)
  # ============================================================================
  picker:
    # If true, restrict P/S search region to the part of the trace where
    # detection probabilities exceed det_window_threshold.
    use_detection_window: true

    # Minimum detection probability for a time sample to be included in the
    # detection-based search window.
    det_window_threshold: 0.3

    # Minimum required Gaussian amplitude for accepting a predicted P or S pick.
    # If the maximum Gaussian value is below this threshold, the phase is rejected.
    p_amp_threshold: 0.1
    s_amp_threshold: 0.1

    # Optional constraints for stabilizing phase picking.
    # Minimum allowed P–S time separation in seconds.
    min_ps_gap_sec: 0.02

    # Additional padding (in seconds) around the detection window to expand
    # the candidate search region for P/S phases.
    max_search_pad_sec: 0.5

  # ============================================================================
  # Phase Pick Error Tolerances (Used for Reporting Accuracy)
  # ============================================================================
  phase_tolerance:
    # Thresholds (in seconds) used for computing hit-rate statistics.
    # Example:
    #   hit_rate_small = percentage(|error| < small)
    #   hit_rate_medium = percentage(|error| < medium)
    #   hit_rate_large = percentage(|error| < large)
    p:
      small: 0.01
      medium: 0.02
      large: 0.05

    s:
      small: 0.01
      medium: 0.02
      large: 0.05

  # ============================================================================
  # Evaluation Output Configuration
  # ============================================================================
  eval:
    # Number of batches to evaluate. If null, the entire validation/test
    # dataset will be used.
    max_batches: null

    # Save final aggregated metrics as JSON (e.g., val_metrics.json).
    save_json: true

    # If true, save per-trace metrics (detection outcome, P/S picks, errors)
    # into a CSV file for detailed analysis.
    save_per_trace_csv: false

    # Directory name (within the experiment folder) where evaluation outputs
    # will be stored.
    output_dir: "metrics"
